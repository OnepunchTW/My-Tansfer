<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>通勤轉乘儀錶板 v2.2 (大字版)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; padding-bottom: 100px; }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.1); }
        input[type="time"]::-webkit-calendar-picker-indicator { background: transparent; bottom: 0; color: transparent; cursor: pointer; height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Config Constants ---
        const STATIONS = {
            TRA: { yuanlin: '3360', xinwuri: '3340', nangang: '0900' },
            HSR: { taichung: '1030', taipei: '1000', nangang: '0990' }
        };

        const TRANSFER_BUFFER = {
            TRA_HSR_XINWURI: 10,
            HSR_MRT_NANGANG: 10,
            HSR_MRT_TAIPEI: 10,
            MRT_TRANSFER_GENERIC: 5
        };

        const MRT_TRAVEL_TIME = {
            TP_TO_SYS: 15,
            SYS_TO_NANGANG: 12
        };

        // --- Mock Data ---
        const MOCK_DATA = {
            north: [
                {
                    totalDuration: '2時15分',
                    legs: [
                        { type: 'TRA', name: '區間快 2004', dep: '07:10', arr: '07:35', from: '員林', to: '新烏日' },
                        { type: 'TRANSFER', time: '15分', loc: '新烏日/台中' },
                        { type: 'HSR', name: '高鐵 0810', dep: '07:50', arr: '08:50', from: '台中', to: '台北' },
                        { type: 'TRANSFER', time: '10分', loc: '台北轉乘' },
                        { type: 'MRT', name: '捷運藍線', dep: '09:00', arr: '09:15', from: '台北車站', to: '國父紀念館' }
                    ]
                },
                {
                    totalDuration: '2時05分',
                    legs: [
                        { type: 'TRA', name: '自強 112', dep: '07:25', arr: '07:48', from: '員林', to: '新烏日' },
                        { type: 'TRANSFER', time: '17分', loc: '新烏日/台中' },
                        { type: 'HSR', name: '高鐵 0610', dep: '08:05', arr: '09:05', from: '台中', to: '台北' },
                        { type: 'TRANSFER', time: '10分', loc: '台北轉乘' },
                        { type: 'MRT', name: '捷運藍線', dep: '09:15', arr: '09:30', from: '台北車站', to: '國父紀念館' }
                    ]
                }
            ],
            south: [
                {
                    totalDuration: '2時10分',
                    legs: [
                        { type: 'MRT', name: '捷運藍線', dep: '18:00', arr: '18:12', from: '國父紀念館', to: '南港' },
                        { type: 'TRANSFER', time: '10分', loc: '南港轉乘' },
                        { type: 'HSR', name: '高鐵 0845', dep: '18:25', arr: '19:25', from: '南港', to: '台中' },
                        { type: 'TRANSFER', time: '15分', loc: '台中/新烏日' },
                        { type: 'TRA', name: '區間 2243', dep: '19:40', arr: '20:05', from: '新烏日', to: '員林' }
                    ]
                }
            ]
        };

        // --- Helpers ---
        const getTodayDateStr = () => {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const getCurrentTimeStr = () => {
            const d = new Date();
            return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        };

        const addMinutes = (timeStr, mins) => {
            const [h, m] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(h);
            date.setMinutes(m + mins);
            return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        };

        const compareTime = (t1, t2) => {
            const [h1, m1] = t1.split(':').map(Number);
            const [h2, m2] = t2.split(':').map(Number);
            return (h1 * 60 + m1) - (h2 * 60 + m2);
        };

        // --- Components ---

        const TransportIcon = ({ type }) => {
            let bg = 'bg-gray-100';
            let color = 'text-gray-500';
            let icon = 'fa-train';
            let borderColor = 'border-gray-300';

            // High Contrast Schematic Icons
            if (type === 'TRA') { 
                bg = 'bg-teal-600'; // Darker background for white icon
                color = 'text-white'; 
                icon = 'fa-train'; 
                borderColor = 'border-teal-700';
            }
            if (type === 'HSR') { 
                bg = 'bg-orange-500'; 
                color = 'text-white'; 
                icon = 'fa-bolt'; // Bolt for High Speed
                borderColor = 'border-orange-600';
            }
            if (type === 'MRT') { 
                bg = 'bg-blue-700'; 
                color = 'text-white'; 
                icon = 'fa-train-subway'; 
                borderColor = 'border-blue-800';
            }

            return (
                <div className={`w-10 h-10 rounded-full ${bg} border-2 ${borderColor} flex items-center justify-center shrink-0 shadow-md z-10 relative`}>
                    <i className={`fa-solid ${icon} ${color} text-lg`}></i>
                </div>
            );
        };

        const LegRow = ({ leg, isLast }) => {
            if (leg.type === 'TRANSFER') {
                return (
                    <div className="ml-[1.2rem] pl-6 border-l-4 border-dotted border-gray-300 py-2 my-1 text-sm text-gray-600 flex items-center font-medium">
                        <i className="fa-solid fa-person-walking mr-2 text-base"></i>
                        <span>{leg.loc} ({leg.time})</span>
                    </div>
                );
            }

            return (
                <div className="flex items-start gap-4 relative py-1">
                    {/* Connection Line */}
                    {!isLast && <div className="absolute left-[1.15rem] top-10 bottom-[-8px] w-1 bg-gray-200 z-0"></div>}
                    
                    <TransportIcon type={leg.type} />
                    
                    <div className="flex-1 pb-4">
                        <div className="flex justify-between items-baseline mb-1">
                            <span className="font-bold text-gray-900 text-3xl">{leg.dep}</span>
                            <span className={`text-sm px-2 py-1 rounded-md font-bold ${
                                leg.type === 'TRA' ? 'bg-teal-100 text-teal-800' : 
                                leg.type === 'HSR' ? 'bg-orange-100 text-orange-800' : 
                                'bg-blue-100 text-blue-900'
                            }`}>{leg.name}</span>
                        </div>
                        <div className="flex justify-between text-base text-gray-600 font-medium">
                            <span>{leg.from}</span>
                            <span className="flex items-center gap-1 text-gray-400">
                                <i className="fa-solid fa-arrow-right"></i>
                            </span>
                            <span>{leg.arr} {leg.to}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const RouteCard = ({ data }) => {
            return (
                <div className="bg-white rounded-2xl p-5 shadow-md border-l-4 border-l-blue-500 border-y border-r border-gray-200 mb-5">
                    <div className="flex justify-between items-center mb-4 pb-3 border-b border-gray-100">
                        <span className="text-sm font-bold text-gray-500 flex items-center gap-1">
                            <i className="fa-regular fa-clock"></i> 總時程 {data.totalDuration}
                        </span>
                        <span className="text-sm font-bold text-white bg-blue-600 px-3 py-1 rounded-full shadow-sm">
                            抵達 {data.legs[data.legs.length-1].arr}
                        </span>
                    </div>
                    <div className="relative">
                        {data.legs.map((leg, idx) => (
                            <LegRow key={idx} leg={leg} isLast={idx === data.legs.length - 1} />
                        ))}
                    </div>
                </div>
            );
        };

        const ConfigModal = ({ isOpen, onClose, onSave }) => {
            const [clientId, setClientId] = useState(localStorage.getItem('tdx_client_id') || '');
            const [clientSecret, setClientSecret] = useState(localStorage.getItem('tdx_client_secret') || '');

            if (!isOpen) return null;

            const handleSave = () => {
                localStorage.setItem('tdx_client_id', clientId);
                localStorage.setItem('tdx_client_secret', clientSecret);
                onSave();
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">TDX API 設定</h2>
                        <div className="space-y-5">
                            <div>
                                <label className="block text-base font-bold text-gray-700 mb-2">Client ID</label>
                                <input type="text" value={clientId} onChange={(e) => setClientId(e.target.value)} className="w-full p-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none" placeholder="輸入 ID" />
                            </div>
                            <div>
                                <label className="block text-base font-bold text-gray-700 mb-2">Client Secret</label>
                                <input type="password" value={clientSecret} onChange={(e) => setClientSecret(e.target.value)} className="w-full p-3 text-lg border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none" placeholder="輸入 Secret" />
                            </div>
                        </div>
                        <div className="mt-8 flex gap-4">
                            <button onClick={onClose} className="flex-1 py-3 text-lg text-gray-600 font-bold bg-gray-100 rounded-xl">取消</button>
                            <button onClick={handleSave} className="flex-1 py-3 text-lg bg-blue-600 text-white rounded-xl font-bold shadow-lg">儲存</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [direction, setDirection] = useState('north');
            const [customTime, setCustomTime] = useState(getCurrentTimeStr());
            const [routes, setRoutes] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [isConfigOpen, setIsConfigOpen] = useState(false);
            const [useDemo, setUseDemo] = useState(true);

            const fetchTDXData = async () => {
                const clientId = localStorage.getItem('tdx_client_id');
                const clientSecret = localStorage.getItem('tdx_client_secret');

                if (!clientId || !clientSecret) {
                    setUseDemo(true);
                    setRoutes(MOCK_DATA[direction]);
                    return;
                }

                setLoading(true);
                setError('');
                
                try {
                    const tokenParams = new URLSearchParams();
                    tokenParams.append('grant_type', 'client_credentials');
                    tokenParams.append('client_id', clientId);
                    tokenParams.append('client_secret', clientSecret);

                    const tokenRes = await fetch('https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: tokenParams
                    });

                    if (!tokenRes.ok) throw new Error('API 認證失敗');
                    const tokenData = await tokenRes.json();
                    const accessToken = tokenData.access_token;
                    const date = getTodayDateStr();

                    let results = [];

                    if (direction === 'north') {
                        const traUrl = `https://tdx.transportdata.tw/api/basic/v3/Rail/TRA/DailyTrainTimetable/OD/${STATIONS.TRA.yuanlin}/to/${STATIONS.TRA.xinwuri}/${date}?$format=JSON`;
                        const hsrUrl = `https://tdx.transportdata.tw/api/basic/v2/Rail/THSR/DailyTimetable/OD/${STATIONS.HSR.taichung}/to/${STATIONS.HSR.taipei}/${date}?$format=JSON`;

                        const [traRes, hsrRes] = await Promise.all([
                            fetch(traUrl, { headers: { 'Authorization': `Bearer ${accessToken}` } }),
                            fetch(hsrUrl, { headers: { 'Authorization': `Bearer ${accessToken}` } })
                        ]);

                        const traData = await traRes.json();
                        const hsrData = await hsrRes.json();

                        const validTra = traData.TrainTimetables
                            .filter(t => compareTime(t.StopTimes[0].DepartureTime, customTime) >= 0)
                            .sort((a, b) => compareTime(a.StopTimes[0].DepartureTime, b.StopTimes[0].DepartureTime))
                            .slice(0, 3);

                        validTra.forEach(t => {
                            const traInfo = t.TrainInfo;
                            const depStop = t.StopTimes.find(s => s.StationID === STATIONS.TRA.yuanlin);
                            const arrStop = t.StopTimes.find(s => s.StationID === STATIONS.TRA.xinwuri);
                            
                            const earliestHsrDep = addMinutes(arrStop.ArrivalTime, TRANSFER_BUFFER.TRA_HSR_XINWURI);
                            const bestHsr = hsrData
                                .filter(h => compareTime(h.OriginStopTime.DepartureTime, earliestHsrDep) >= 0)
                                .sort((a, b) => compareTime(a.OriginStopTime.DepartureTime, b.OriginStopTime.DepartureTime))[0];

                            if (bestHsr) {
                                const hsrArrTime = bestHsr.DestinationStopTime.ArrivalTime;
                                const mrtDepTime = addMinutes(hsrArrTime, TRANSFER_BUFFER.HSR_MRT_TAIPEI);
                                const mrtArrTime = addMinutes(mrtDepTime, MRT_TRAVEL_TIME.TP_TO_SYS);

                                results.push({
                                    totalDuration: Math.floor((compareTime(mrtArrTime, depStop.DepartureTime))/60) + '時' + (compareTime(mrtArrTime, depStop.DepartureTime)%60) + '分',
                                    legs: [
                                        { type: 'TRA', name: traInfo.TrainTypeName.Zh_tw.replace('臺鐵','') + ' ' + traInfo.TrainNo, dep: depStop.DepartureTime, arr: arrStop.ArrivalTime, from: '員林', to: '新烏日' },
                                        { type: 'TRANSFER', time: TRANSFER_BUFFER.TRA_HSR_XINWURI + '分', loc: '新烏日轉乘' },
                                        { type: 'HSR', name: '高鐵 ' + bestHsr.DailyTrainInfo.TrainNo, dep: bestHsr.OriginStopTime.DepartureTime, arr: bestHsr.DestinationStopTime.ArrivalTime, from: '台中', to: '台北' },
                                        { type: 'TRANSFER', time: TRANSFER_BUFFER.HSR_MRT_TAIPEI + '分', loc: '台北轉捷運' },
                                        { type: 'MRT', name: '捷運藍線', dep: mrtDepTime, arr: mrtArrTime, from: '台北車站', to: '國父紀念館' }
                                    ]
                                });
                            }
                        });

                    } else {
                        const mrtDep = customTime;
                        const mrtArrNangang = addMinutes(mrtDep, MRT_TRAVEL_TIME.SYS_TO_NANGANG);
                        const hsrMinDep = addMinutes(mrtArrNangang, TRANSFER_BUFFER.HSR_MRT_NANGANG);

                        const hsrUrl = `https://tdx.transportdata.tw/api/basic/v2/Rail/THSR/DailyTimetable/OD/${STATIONS.HSR.nangang}/to/${STATIONS.HSR.taichung}/${date}?$format=JSON`;
                        const traUrl = `https://tdx.transportdata.tw/api/basic/v3/Rail/TRA/DailyTrainTimetable/OD/${STATIONS.TRA.xinwuri}/to/${STATIONS.TRA.yuanlin}/${date}?$format=JSON`;

                        const [hsrRes, traRes] = await Promise.all([
                            fetch(hsrUrl, { headers: { 'Authorization': `Bearer ${accessToken}` } }),
                            fetch(traUrl, { headers: { 'Authorization': `Bearer ${accessToken}` } })
                        ]);

                        const hsrData = await hsrRes.json();
                        const traData = await traRes.json();

                        const validHsr = hsrData
                            .filter(h => compareTime(h.OriginStopTime.DepartureTime, hsrMinDep) >= 0)
                            .sort((a, b) => compareTime(a.OriginStopTime.DepartureTime, b.OriginStopTime.DepartureTime))
                            .slice(0, 3);

                        validHsr.forEach(h => {
                            const hsrInfo = h.DailyTrainInfo;
                            const hsrDep = h.OriginStopTime.DepartureTime;
                            const hsrArr = h.DestinationStopTime.ArrivalTime;
                            
                            const traMinDep = addMinutes(hsrArr, TRANSFER_BUFFER.TRA_HSR_XINWURI);
                            const bestTra = traData.TrainTimetables
                                .filter(t => {
                                    const s = t.StopTimes.find(s => s.StationID === STATIONS.TRA.xinwuri);
                                    return s && compareTime(s.DepartureTime, traMinDep) >= 0;
                                })
                                .sort((a, b) => {
                                    const da = a.StopTimes.find(s => s.StationID === STATIONS.TRA.xinwuri).DepartureTime;
                                    const db = b.StopTimes.find(s => s.StationID === STATIONS.TRA.xinwuri).DepartureTime;
                                    return compareTime(da, db);
                                })[0];
                            
                            if (bestTra) {
                                const traDepStop = bestTra.StopTimes.find(s => s.StationID === STATIONS.TRA.xinwuri);
                                const traArrStop = bestTra.StopTimes.find(s => s.StationID === STATIONS.TRA.yuanlin);

                                results.push({
                                    totalDuration: Math.floor((compareTime(traArrStop.ArrivalTime, mrtDep))/60) + '時' + (compareTime(traArrStop.ArrivalTime, mrtDep)%60) + '分',
                                    legs: [
                                        { type: 'MRT', name: '捷運藍線', dep: mrtDep, arr: mrtArrNangang, from: '國父紀念館', to: '南港' },
                                        { type: 'TRANSFER', time: TRANSFER_BUFFER.HSR_MRT_NANGANG + '分', loc: '南港轉乘' },
                                        { type: 'HSR', name: '高鐵 ' + hsrInfo.TrainNo, dep: hsrDep, arr: hsrArr, from: '南港', to: '台中' },
                                        { type: 'TRANSFER', time: TRANSFER_BUFFER.TRA_HSR_XINWURI + '分', loc: '新烏日轉乘' },
                                        { type: 'TRA', name: bestTra.TrainInfo.TrainTypeName.Zh_tw.replace('臺鐵','') + ' ' + bestTra.TrainInfo.TrainNo, dep: traDepStop.DepartureTime, arr: traArrStop.ArrivalTime, from: '新烏日', to: '員林' }
                                    ]
                                });
                            }
                        });
                    }

                    setRoutes(results);
                    setUseDemo(false);

                } catch (err) {
                    console.error(err);
                    setRoutes(MOCK_DATA[direction]);
                    setUseDemo(true);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchTDXData();
            }, [direction, customTime]);

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-50 flex flex-col relative">
                    <div className="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-6 rounded-b-3xl shadow-lg sticky top-0 z-20">
                        <div className="flex justify-between items-center mb-5">
                            <h1 className="text-2xl font-bold tracking-tight">
                                <i className="fa-solid fa-diamond-turn-right text-yellow-400 mr-2"></i>
                                通勤指揮官
                            </h1>
                            <button onClick={() => setIsConfigOpen(true)}>
                                <i className="fa-solid fa-gear text-gray-300 text-xl hover:text-white transition"></i>
                            </button>
                        </div>
                        
                        <div className="flex bg-gray-700/50 p-1.5 rounded-xl backdrop-blur-md">
                            <button onClick={() => setDirection('north')} className={`flex-1 py-3 rounded-lg text-base font-bold flex items-center justify-center gap-2 transition-all ${direction === 'north' ? 'bg-white text-gray-900 shadow-md' : 'text-gray-300'}`}>
                                <i className="fa-solid fa-briefcase"></i> 上班
                            </button>
                            <button onClick={() => setDirection('south')} className={`flex-1 py-3 rounded-lg text-base font-bold flex items-center justify-center gap-2 transition-all ${direction === 'south' ? 'bg-white text-gray-900 shadow-md' : 'text-gray-300'}`}>
                                <i className="fa-solid fa-house"></i> 回家
                            </button>
                        </div>
                    </div>

                    <div className="flex-1 px-4 py-5 relative">
                        {loading ? (
                            <div className="text-center py-20 text-gray-400">
                                <i className="fa-solid fa-circle-notch fa-spin text-4xl mb-3"></i>
                                <p className="text-lg">計算路徑中...</p>
                            </div>
                        ) : (
                            <div>
                                <div className="mb-3 text-sm text-gray-600 font-bold flex justify-between px-2">
                                    <span>{direction === 'north' ? '員林出發' : '國父紀念館出發'} ({customTime})</span>
                                    <span>最近 3 班</span>
                                </div>
                                {routes.map((route, idx) => (
                                    <RouteCard key={idx} data={route} />
                                ))}
                                {routes.length === 0 && (
                                    <div className="text-center py-12 text-gray-400 text-lg">此時段無合適班次</div>
                                )}
                            </div>
                        )}
                        {useDemo && !loading && (
                            <div className="text-sm text-center text-yellow-700 bg-yellow-100 p-3 rounded-lg mt-2 font-medium">
                                <i className="fa-solid fa-triangle-exclamation mr-1"></i>
                                模擬資料模式：請設定金鑰以取得即時班次
                            </div>
                        )}
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 glass-nav p-5 pb-8 z-30 flex items-center justify-center max-w-md mx-auto">
                        <div className="flex items-center gap-4 bg-white px-6 py-3 rounded-full shadow-xl border-2 border-gray-100 w-full max-w-sm cursor-pointer hover:border-blue-200 transition">
                            <i className="fa-regular fa-clock text-blue-600 text-2xl"></i>
                            <span className="text-lg font-bold text-gray-600 whitespace-nowrap">出發</span>
                            <input 
                                type="time" 
                                value={customTime} 
                                onChange={(e) => setCustomTime(e.target.value)}
                                className="flex-1 text-3xl font-bold text-gray-900 bg-transparent outline-none text-right font-mono"
                            />
                        </div>
                    </div>

                    <ConfigModal isOpen={isConfigOpen} onClose={() => setIsConfigOpen(false)} onSave={() => fetchTDXData()} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
